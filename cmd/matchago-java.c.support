#include <jni.h>
#include <stdlib.h>
#include <string.h>
#include "matchago-java.h"
#include "matchago.h"
#include "matchaforeign-java.h"
#include <stdbool.h>
#include <stdio.h>
#include <android/log.h>

#define printf(...) __android_log_print(ANDROID_LOG_DEBUG, "TAG", __VA_ARGS__);

void TestFunc();

jint JNI_OnLoad(JavaVM* vm, void* reserved)
{
    printf("WTF!!!");
    return JNI_VERSION_1_6;
}


JNIEXPORT void JNICALL Java_io_gomatcha_bridge_MatchaGoValue_matchaInit(JNIEnv *, jclass, jobject) {
    sEnv = env;
    sTracker = (*env)->NewGlobalRef(env, tracker);
    TestFunc();
}

JNIEXPORT jlong JNICALL Java_io_gomatcha_bridge_MatchaGoValue_matchaGoBool(JNIEnv *, jclass, jboolean) {
    return matchaGoBool(v);
}

JNIEXPORT jlong JNICALL Java_io_gomatcha_bridge_MatchaGoValue_matchaGoLong(JNIEnv *, jclass, jlong) {
    return matchaGoInt64(v);
}

JNIEXPORT jlong JNICALL Java_io_gomatcha_bridge_MatchaGoValue_matchaGoDouble(JNIEnv *, jclass, jdouble) {
    return matchaGoFloat64(v);
}

JNIEXPORT jlong JNICALL Java_io_gomatcha_bridge_MatchaGoValue_matchaGoString(JNIEnv *, jclass, jstring) {
    return matchaGoString(MatchaStringToCGoBuffer(env, v));
}

JNIEXPORT jlong JNICALL Java_io_gomatcha_bridge_MatchaGoValue_matchaGoByteArray(JNIEnv *, jclass, jbyteArray) {
    CGoBuffer cstr = MatchaByteArrayToCGoBuffer(env, v);
    return matchaGoBytes(cstr);
}

JNIEXPORT jlong JNICALL Java_io_gomatcha_bridge_MatchaGoValue_matchaGoArray(JNIEnv *, jclass, jlongArray) {
    int len = (*env)->GetArrayLength(env, v);
    GoRef array = matchaGoArray();
    
    jlong *arr = (*env)->GetLongArrayElements(env, v, 0);
    for (int i = 0; i < len; i++) {
        GoRef prev = array;
        array = matchaGoArrayAppend(array, arr[i]);
        matchaGoUntrack(prev);
    }
    
    (*env)->ReleaseLongArrayElements(env, v, arr, 0);
    return array;
}

JNIEXPORT jlong JNICALL Java_io_gomatcha_bridge_MatchaGoValue_matchaGoFunc(JNIEnv *, jclass, jstring) {
    return matchaGoFunc(MatchaStringToCGoBuffer(env, v));
}

JNIEXPORT jlong JNICALL Java_io_gomatcha_bridge_MatchaGoValue_matchaGoType(JNIEnv *, jclass, jstring) {
    return matchaGoType(MatchaStringToCGoBuffer(env, v));
}

JNIEXPORT jboolean JNICALL Java_io_gomatcha_bridge_MatchaGoValue_matchaGoToBool(JNIEnv *, jclass, jlong) {
    return matchaGoToBool(v);
}

JNIEXPORT jlong JNICALL Java_io_gomatcha_bridge_MatchaGoValue_matchaGoToLong(JNIEnv *, jclass, jlong) {
    return matchaGoToInt64(v);
}

JNIEXPORT jdouble JNICALL Java_io_gomatcha_bridge_MatchaGoValue_matchaGoToDouble(JNIEnv *, jclass, jlong) {
    return matchaGoToFloat64(v);
}

JNIEXPORT jstring JNICALL Java_io_gomatcha_bridge_MatchaGoValue_matchaGoToString(JNIEnv *, jclass, jlong) {
    CGoBuffer buf = matchaGoToString(v);
    return MatchaCGoBufferToString(env, buf);
}

JNIEXPORT jbyteArray JNICALL Java_io_gomatcha_bridge_MatchaGoValue_matchaGoToByteArray(JNIEnv *, jclass, jlong) {
    CGoBuffer buf = matchaGoToBytes(v);
    jbyteArray a = MatchaCGoBufferToByteArray(env, buf);
    return a;
}

JNIEXPORT jlongArray JNICALL Java_io_gomatcha_bridge_MatchaGoValue_matchaGoToArray(JNIEnv *, jclass, jlong) {
    int len = matchaGoArrayLen(v);
    jlongArray array = (*env)->NewLongArray(env, len);
    jlong *arr = (*env)->GetLongArrayElements(env, array, NULL);
    for (int i = 0; i < len; i++) {
        arr[i] = matchaGoArrayAt(v, i);
    }
    
    (*env)->ReleaseLongArrayElements(env, array, arr, 0);
    return array;
}

JNIEXPORT jlong JNICALL Java_io_gomatcha_bridge_MatchaGoValue_matchaGoElem(JNIEnv *, jclass, jlong) {
    return matchaGoElem(v);
}

JNIEXPORT jboolean JNICALL Java_io_gomatcha_bridge_MatchaGoValue_matchaGoIsNil(JNIEnv *, jclass, jlong) {
    return matchaGoIsNil(v);
}

JNIEXPORT jboolean JNICALL Java_io_gomatcha_bridge_MatchaGoValue_matchaGoEqual(JNIEnv *, jclass, jlong, jlong) {
    return matchaGoEqual(v, v2);
}

JNIEXPORT jlong JNICALL Java_io_gomatcha_bridge_MatchaGoValue_matchaGoCall(JNIEnv *, jclass, jlong, jstring, jlong) {
    return matchaGoCall(v, MatchaStringToCGoBuffer(env, v2), v3);
}

JNIEXPORT jlong JNICALL Java_io_gomatcha_bridge_MatchaGoValue_matchaGoField(JNIEnv *, jclass, jlong, jstring) {
    return matchaGoField(v, MatchaStringToCGoBuffer(env, v2));
}

JNIEXPORT void JNICALL Java_io_gomatcha_bridge_MatchaGoValue_matchaGoFieldSet(JNIEnv *, jclass, jlong, jstring, jlong) {
    matchaGoFieldSet(v, MatchaStringToCGoBuffer(env, v2), v3);
}

JNIEXPORT void JNICALL Java_io_gomatcha_bridge_MatchaGoValue_matchaGoUntrack(JNIEnv *, jclass, jlong) {
    matchaGoUntrack(v);
}
